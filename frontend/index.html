<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Parcelas - Chile's Yearly Clear Sky Percentage</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="map"></div>
    <div id="debug">
      <strong>Debug Log (Press '?' to toggle)</strong>
      <div id="debug-content"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="config.js"></script>
    <script>
      // --- Debug Logger ---
      const debugLog = (msg, type = 'info') => {
        console.log(`[${type.toUpperCase()}]`, msg);
        const debugContent = document.getElementById('debug-content');
        const timestamp = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = type;
        line.textContent = `[${timestamp}] ${msg}`;
        debugContent.appendChild(line);
        debugContent.scrollTop = debugContent.scrollHeight;
      };

      // Toggle debug panel with '?' key
      document.addEventListener('keydown', (e) => {
        if (e.key === '?') {
          document.getElementById('debug').classList.toggle('visible');
        }
      });

      // Detect environment
      const isLocal = window.location.hostname === 'localhost' 
        || window.location.hostname === '127.0.0.1';
      
      const API_BASE_URL = isLocal
        ? 'http://localhost:8080'
        : 'https://parcelas-api-228350087170.us-central1.run.app';

      debugLog(`Environment: ${isLocal ? 'LOCAL' : 'PRODUCTION'}`, 'info');
      debugLog(`API Base URL: ${API_BASE_URL}`, 'info');
      debugLog(`Hostname: ${window.location.hostname}`, 'info');

      // Test API connectivity
      const testAPI = async () => {
        debugLog('Testing API connectivity...', 'info');
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          if (response.ok) {
            const data = await response.json();
            debugLog(`API health check: ${JSON.stringify(data)}`, 'success');
          } else {
            debugLog(`API health check failed: ${response.status} ${response.statusText}`, 'error');
          }
        } catch (err) {
          debugLog(`API health check error: ${err.message}`, 'error');
          if (err.message.includes('blocked')) {
            debugLog('Request may be blocked by ad blocker or CORS', 'error');
          }
        }
      };

      testAPI();

      // --- Colorbar as a Leaflet Control ---
      const ColorBar = L.Control.extend({
        options: {
          position: 'bottomright'
        },
        onAdd: function () {
          const container = L.DomUtil.create('div', 'leaflet-colorbar');

          const title = L.DomUtil.create('div', 'colorbar-title');
          title.textContent = 'Clear Sky Days (%)';
          title.style.cssText = 'font-size:12px; font-family:sans-serif; color:#333; margin-bottom:5px; font-weight:bold; text-align:center; width:180px;';
          container.appendChild(title);

          const gradient = L.DomUtil.create('div', 'colorbar-gradient');
          container.appendChild(gradient);

          const labels = L.DomUtil.create('div', 'colorbar-labels');
          ['0', '50', '100'].forEach(function (val) {
            const span = document.createElement('span');
            span.textContent = val;
            labels.appendChild(span);
          });
          container.appendChild(labels);
          return container;
        }
      });

      // --- GitHub Link Control ---
      const GitHubLink = L.Control.extend({
        options: {
          position: 'bottomleft'
        },
        onAdd: function () {
          const container = L.DomUtil.create('div', 'leaflet-github');
          container.innerHTML = `
            <a href="https://github.com/gcaria/parcelas" target="_blank" rel="noopener noreferrer">
              <svg height="16" width="16" viewBox="0 0 16 16" style="vertical-align:middle; margin-right:5px;">
                <path fill="#333" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
                  0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
                  -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2
                  -3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82
                  .64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08
                  2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01
                  1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
              </svg>
              View on GitHub
            </a>
          `;
          return container;
        }
      });


      // --- Create map ---
      debugLog('Initializing map...', 'info');
      const map = L.map("map").setView([-39.28, -72.25], 8);

      // Basemap
      debugLog('Adding basemap layer...', 'info');
      const basemap = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap"
      }).addTo(map);

      basemap.on('load', () => debugLog('Basemap loaded successfully', 'success'));
      basemap.on('tileerror', (e) => debugLog(`Basemap tile error: ${e.tile.src}`, 'error'));

      // TiTiler mosaic tiles
      const tileUrl = `${API_BASE_URL}/mosaicjson/tiles/WebMercatorQuad/{z}/{x}/{y}.png`
        + "?url=gs://parcelas-wrs2/mosaics/mosaic_clipped.json.gz"
        + "&rescale=0,100&colormap_name=coolwarm&clamp=true"
        + `&api_key=${API_KEY}`;
      
      debugLog(`Tile URL template: ${tileUrl}`, 'info');

      const mosaicLayer = L.tileLayer(tileUrl, {
        tileSize: 256,
        opacity: 0.8
      }).addTo(map);

      // Track tile loading
      let tilesLoaded = 0;
      let tilesErrored = 0;

      mosaicLayer.on('tileloadstart', (e) => {
        debugLog(`Loading tile: ${e.url}`, 'info');
      });

      mosaicLayer.on('tileload', (e) => {
        tilesLoaded++;
        debugLog(`Tile loaded successfully (${tilesLoaded} total)`, 'success');
      });

      mosaicLayer.on('tileerror', (e) => {
        tilesErrored++;
        debugLog(`Tile error (${tilesErrored} total): ${e.tile.src}`, 'error');
        debugLog(`Error coords: z=${e.coords.z}, x=${e.coords.x}, y=${e.coords.y}`, 'error');
      });

      mosaicLayer.on('loading', () => debugLog('Mosaic layer loading...', 'info'));
      mosaicLayer.on('load', () => debugLog('Mosaic layer load complete', 'success'));

      debugLog('Adding colorbar control...', 'info');
      new ColorBar().addTo(map);

      debugLog('Adding github link...', 'info');
      new GitHubLink().addTo(map);

      // Log map events
      map.on('zoomend', () => debugLog(`Zoom level: ${map.getZoom()}`, 'info'));
      map.on('moveend', () => {
        const center = map.getCenter();
        debugLog(`Map center: [${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}]`, 'info');
      });

      // Catch global errors
      window.addEventListener('error', (e) => {
        debugLog(`Global error: ${e.message}`, 'error');
      });

      debugLog('Map initialization complete', 'success');
      debugLog('Press ? to toggle this debug panel', 'info');
    </script>
  </body>
</html>
